# Design: FEAT-006 - Agent Session Management

**Feature ID**: FEAT-006
**Status**: Draft
**Owner**: Yggdrasil Team
**Created**: 2026-02-01
**Updated**: 2026-02-01

## Design Goals
- Manage agent CLIs with minimal, non-invasive control (tmux + CLI/stdin)
- Preserve native subscription sessions (no API-key requirements for MVP)
- Provide consistent session lifecycle state and audit trails
- Capture resource and token usage when available

## Non-Goals
- Remote or multi-machine session control
- Agent-specific UI enhancements beyond attach/detach
- API-based agent integrations

## Architecture Overview
Sessions are launched in tmux and tracked by a local session store. A thin agent adapter layer captures per-agent specifics (start/resume/token usage), while common lifecycle and telemetry are handled in a shared manager.

```
[yg session start]
  -> SessionManager
     -> AgentAdapter (agent-specific command flags)
     -> TmuxDriver (launch, attach, send-keys, capture)
     -> SessionStore (metadata + events)
     -> TelemetryCollector (resource + token usage)
```

## Key Decisions
- Control surfaces: CLI + tmux only
- No wrapper unless required by a specific agent
- Native session reuse is required to preserve subscription benefits
- Session failures tracked separately from agent-caused failures

## Session Model

### Identifiers
- `session_id` generated by Yggdrasil
- `tmux_session_name` = `yg-<session_id>`

### State Transitions
- `starting` -> `running`
- `running` -> `waiting_input` (heuristic based on prompts or inactivity)
- `running`/`waiting_input` -> `stopping` -> `stopped`
- Any -> `failed` on non-zero exit
- `unknown` when signals are missing

## Agent Adapter Interface
Each agent has a lightweight adapter that supplies commands and parsing details.

```
type AgentAdapter interface {
  Type() AgentType
  StartCommand(params StartParams) CommandSpec
  ResumeCommand(params ResumeParams) CommandSpec
  TokenUsageCollector(session Session) (UsageSample, bool)
  SupportsInteractive() bool
}
```

Adapters map to known CLI flags (from spikes):
- Claude Code: `--session-id`, `--resume`, `--output-format json`
- Gemini CLI: `--list-sessions`, `--resume`, `--output-format json`
- Codex CLI: `exec --json`, `resume`, `fork`
- OpenCode CLI: `run`, `session`, `stats`, `export`

## Tmux Control Layer
- Launch: `tmux new-session -d -s <name> <cmd>`
- Attach: `tmux attach -t <name>`
- Send input: `tmux send-keys -t <name> "..." C-m`
- Capture output: `tmux capture-pane -p -t <name>`
- Stop: `tmux kill-session -t <name>`

## Session Store
Session metadata is stored under XDG state.

```
$XDG_STATE_HOME/yggdrasil/sessions/<session_id>/
  session.json
  events.jsonl
  telemetry.jsonl
  output.log
```

### Stored Fields
- `session_id`, `agent_type`, `agent_version`, `yg_version`, `project_name`
- `state`, `started_at`, `ended_at`
- `tmux_session_name`, `workspace_id`, `task_id` (if available)

## Telemetry Collection

### Resource Usage
- Primary source: `/proc/<pid>` (Linux) and `ps` fallback
- PID derived via `tmux list-panes -F "#{pane_pid}"` and child resolution
- Collector writes samples to `telemetry.jsonl`

### Token Usage
- Per-agent token collectors using native CLI output where available
- Samples appended to telemetry stream with partial data allowed

### Sampling Strategy
- Sampling is handled by collectors; session manager does not enforce an interval

## CLI Surface (MVP)
- `yg session start --agent <type> [--task <id>] [--workspace <id>]`
- `yg session attach <session_id>`
- `yg session send <session_id> --text "..."`
- `yg session stop <session_id>`
- `yg session list`
- `yg session inspect <session_id>`

## Error Handling
- Missing agent CLI -> clear error and doctor hint
- Tmux missing -> clear error and doctor hint
- Attach to missing session -> error + guidance
- Token usage unavailable -> log warning only

## Security and Privacy
- No secrets logged; redact known env vars and tokens
- Session logs are local-only in XDG state directory

## Test Strategy
- Unit tests for adapter command specs
- Integration tests with fake tmux driver
- End-to-end tests for start/attach/send/stop (smoke)
- Telemetry collector tests for `/proc` parsing

## Risks and Mitigations
- Agent TUI changes -> adapter per agent isolates flags and capture behavior
- Missing token usage -> allow partial telemetry
- Tmux instability -> retry attach and ensure cleanup

## Open Questions
None

---
*Design phase document for FEAT-006.*
